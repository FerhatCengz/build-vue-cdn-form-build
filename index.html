<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>Form OluÅŸturucu ve Ã–nizleme</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <!-- jQuery UI -->
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"
    />
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <!-- FormBuilder & FormRender -->
    <link
      rel="stylesheet"
      href="https://formbuilder.online/assets/css/form-builder.min.css"
    />
    <script src="https://formbuilder.online/assets/js/form-builder.min.js"></script>
    <script src="https://formbuilder.online/assets/js/form-render.min.js"></script>

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>


    <style>
      body {
        background: #f8f9fa;
      }
      #fb-editor {
        min-height: 500px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: #fff;
        padding: 10px;
      }
      .preview-box {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        min-height: 500px;
      }
      textarea {
        width: 100%;
        height: 200px;
        font-family: monospace;
        font-size: 14px;
      }

      /* -----------------------------------------------------------
         HR kullanÄ±cÄ±larÄ± iÃ§in geliÅŸmiÅŸ dÃ¼zenleme alanlarÄ±nÄ± gizle
         - class/className
         - name/field_name
         - access/limit_access
         - other/enableOther (DiÄŸerini EtkinleÅŸtir)
         - toggle/switch (GeÃ§iÅŸ yapÄ±sÄ±)
         UI tarafÄ±nda gizlemek tek baÅŸÄ±na yeterli deÄŸil; JS ile sanitize da yapÄ±yoruz.
      ----------------------------------------------------------- */
      .fb-editor .form-group input[name="className"],
      .fb-editor .form-group input[name="class"],
      .fb-editor .form-group select[name="className"],
      .fb-editor .form-group select[name="class"],
      .fb-editor .form-group input[name="name"],
      .fb-editor .form-group input[name="field_name"],
      .fb-editor .form-group input[name="access"],
      .fb-editor .form-group select[name="access"],
      .fb-editor .form-group input[name="access[]"],
      .fb-editor .form-group input[name="limit_access"],
      .fb-editor .form-group input[name="other"],
      .fb-editor .form-group input[name="enableOther"],
      .fb-editor .form-group input[type="checkbox"][name*="other"],
      .fb-editor .form-group input[name="toggle"],
      .fb-editor .form-group input[name="switch"],
      .fb-editor .form-group input[type="checkbox"][name*="toggle"],
      .fb-editor .form-group input[type="checkbox"][name*="switch"],
      .fb-editor .form-group label[for="className"],
      .fb-editor .form-group label[for="class"],
      .fb-editor .form-group label[for="name"],
      .fb-editor .form-group label[for="field_name"],
      .fb-editor .form-group label[for="access"],
      .fb-editor .form-group label[for="limit_access"],
      .fb-editor .form-group label[for="other"],
      .fb-editor .form-group label[for="enableOther"],
      .fb-editor .form-group label[for="toggle"],
      .fb-editor .form-group label[for="switch"],
      .save-template,
      .get-data
      {
        display: none !important;
      }

   

      /* Otomatik deÄŸer bilgisi iÃ§in stil */
      .auto-value-info {
        font-size: 0.75rem;
        font-style: italic;
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid mt-4">
      <div class="row" id="app">
        <!-- Form Builder -->
        <div class="col-md-4">
          <h4 class="mb-3">ğŸ› ï¸ Form OluÅŸturucu</h4>
          <div id="fb-editor"></div>
          <!-- Kendi basit araÃ§ Ã§ubuÄŸumuz (Temizle gibi) buraya enjekte edilecek -->
          <div id="ys-toolbar" class="mt-2"></div>
        </div>

        <!-- Form Ã–nizleme -->
        <div class="col-md-4">
          <h4 class="mb-3">ğŸ‘€ Form Ã–nizleme</h4>
          <div class="preview-box">
            <form id="form-preview"></form>
          </div>
        </div>

        <!-- JSON / HTML Ã‡Ä±ktÄ±sÄ± -->
        <div class="col-md-4">
          <h4 class="mb-3">ğŸ“¦ Ã‡Ä±ktÄ±lar</h4>
          <label><b>JSON FormatÄ±</b></label>
          <textarea id="json-output" readonly></textarea>

          <label class="mt-3"><b>HTML FormatÄ±</b></label>
          <textarea id="html-output" readonly></textarea>
        </div>
      </div>
    </div>

    <script>
      /* ============================================================
         YardÄ±mcÄ± Fonksiyonlar (stateless)
      ============================================================ */

      /**
       * GÃ¼venli karÅŸÄ±laÅŸtÄ±rma: JSON.stringify ile derin eÅŸitlik.
       * @param {any} a
       * @param {any} b
       * @returns {boolean}
       */
      const deepEqual = (a, b) => {
        try {
          return JSON.stringify(a) === JSON.stringify(b);
        } catch {
          return false;
        }
      };

      /**
       * Basit debounce helper
       * @param {Function} fn
       * @param {number} wait
       * @returns {Function}
       */
      const debounce = (fn, wait = 120) => {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(null, args), wait);
        };
      };

      /**
       * TÃ¼rkÃ§e karakterleri de dikkate alan slugify
       * @param {string} s
       * @returns {string}
       */
      const slugify = (s) => {
        if (!s) return "";
        const map = {
          Ã§: "c",
          Ã‡: "c",
          ÄŸ: "g",
          Ä: "g",
          ÅŸ: "s",
          Å: "s",
          Ã¼: "u",
          Ãœ: "u",
          Ã¶: "o",
          Ã–: "o",
          Ä±: "i",
          Ä°: "i",
          Ã±: "n",
        };
        s = s.replace(/./g, (c) => map[c] || c);
        return s
          .toString()
          .toLowerCase()
          .trim()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/-+/g, "-")
          .replace(/^-|-$/g, "");
      };

      /**
       * formBuilder Ã§Ä±ktÄ±sÄ±nÄ± her zaman {obj, str} Ã§iftine normalize eder.
       * @param {any|string} raw
       * @returns {{obj:Array, str:string}}
       */
      const normalizeSchema = (raw) => {
        let obj;
        if (typeof raw === "string") {
          try {
            obj = JSON.parse(raw);
          } catch {
            obj = [];
          }
        } else {
          obj = Array.isArray(raw) ? raw : [];
        }
        let str;
        try {
          str = JSON.stringify(obj, null, 2);
        } catch {
          str = "[]";
        }
        return { obj, str };
      };

      /* ============================================================
         UiPolicyService
         - EditÃ¶r panelindeki geliÅŸmiÅŸ alanlarÄ± gizler (UI)
         - SeÃ§enek (option) deÄŸerlerini label'dan otomatik slug'lar (UI)
         - ÅemanÄ±n (JSON) "gÃ¼venli sÃ¼rÃ¼mÃ¼nÃ¼" Ã¼retir (class/access temizlenmiÅŸ)
      ============================================================ */
      class UiPolicyService {
        /**
         * @param {Object} params
         * @param {HTMLElement} params.root - gÃ¶zlenecek kÃ¶k (genellikle document.body)
         */
        constructor({ root = document.body } = {}) {
          this.root = root;
          this.observeEditPanel(); // editÃ¶rde render oldukÃ§a kurallarÄ± uygula
        }

        /**
         * EditÃ¶r UI'sÄ±nÄ± izler ve kurallarÄ± uygular:
         * - class/name/access alanlarÄ±nÄ± sakla
         * - option value giriÅŸini gizle, label deÄŸiÅŸince value'yu slugla
         */
        observeEditPanel() {
          const applyRules = () => {
            // 1) GeliÅŸmiÅŸ kontrolleri gizle (CSS ile de gizleniyor; JS ile pekiÅŸtiriyoruz)
            const selectors =
              'input[name="className"], input[name="class"], select[name="className"], select[name="class"], input[name="name"], input[name="field_name"], input[name="access"], input[name="access[]"], select[name="access"], input[name="limit_access"], input[name="other"], input[name="enableOther"], input[type="checkbox"][name*="other"], input[name="toggle"], input[name="switch"], input[type="checkbox"][name*="toggle"], input[type="checkbox"][name*="switch"]';
            $(selectors).each(function () {
              $(this).closest(".form-group, .fb-option, .field, .control-group").hide();
            });

            // 2) Option alanlarÄ±nÄ± bul ve slug kuralÄ±nÄ± uygula
            //    FarklÄ± sÃ¼rÃ¼mler farklÄ± DOM yapÄ±larÄ± kullanabilir; olasÄ± kapsayÄ±cÄ±larÄ± tarÄ±yoruz.
            const processedOptions = new Set(); // AynÄ± option'Ä± birden fazla iÅŸlememeye Ã¶nlem
            
            // Daha geniÅŸ selector kullanarak option alanlarÄ±nÄ± yakalayalÄ±m
            $(".sortable-options li, .option-row, .option-item, .fb-option, .field-options .option, .values-wrap .option").each(
              function () {
                const $scope = $(this);
                
                // Bu option daha Ã¶nce iÅŸlenmiÅŸse atla
                const optionId = $scope.attr('data-index') || $scope.index();
                const uniqueKey = `${$scope.closest('.fld-label, .editing-mode, .form-field').attr('id') || 'unknown'}-${optionId}`;
                if (processedOptions.has(uniqueKey)) return;
                processedOptions.add(uniqueKey);

                // Label & Value inputlarÄ±nÄ± farklÄ± yÃ¶ntemlerle bul
                let $label, $value;

                // 1. YÃ¶ntem: Name attribute'larÄ±na gÃ¶re bul
                const $byNameLabel = $scope.find('input[name*="label"], input[placeholder*="Label"], input[placeholder*="Etiket"]');
                const $byNameValue = $scope.find('input[name*="value"], input[placeholder*="Value"], input[placeholder*="DeÄŸer"]');

                if ($byNameLabel.length && $byNameValue.length) {
                  $label = $byNameLabel.first();
                  $value = $byNameValue.first();
                } else {
                  // 2. YÃ¶ntem: ArdÄ±ÅŸÄ±k text inputlarÄ±nÄ± bul
                  const $textInputs = $scope.find('input[type="text"]');
                  if ($textInputs.length >= 2) {
                    $label = $($textInputs.get(0));
                    $value = $($textInputs.get(1));
                  } else {
                    return; // Yeterli input yok
                  }
                }

                if (!$label || !$value || !$label.length || !$value.length) return;

                // Value inputunu gizle ve label'Ä±n yanÄ±na bilgi ekle
                $value.hide();
                
                // Label'Ä±n yanÄ±na "(otomatik)" bilgisi ekle
                if (!$label.next('.auto-value-info').length) {
                  // $label.after('<small class="auto-value-info text-muted ms-1">(deÄŸer otomatik)</small>');
                }

                // Ä°lk deÄŸer boÅŸsa veya label ile eÅŸleÅŸmiyorsa label'dan Ã¼ret
                const currentLabel = $label.val().trim();
                const currentValue = $value.val().trim();
                const expectedValue = slugify(currentLabel);
                
                if (!currentValue || currentValue !== expectedValue) {
                  $value.val(expectedValue);
                }

                // Label deÄŸiÅŸince value'yu otomatik gÃ¼ncelle
                $label.off("input.autoSlug keyup.autoSlug paste.autoSlug")
                      .on("input.autoSlug keyup.autoSlug paste.autoSlug", function () {
                        const newSlug = slugify($(this).val());
                        $value.val(newSlug);
                        
                        // FormBuilder'a deÄŸiÅŸikliÄŸi bildir (eÄŸer events varsa)
                        $value.trigger('change');
                      });

                // Value alanÄ±na kullanÄ±cÄ± mÃ¼dahalesini engelle
                $value.off("input.preventEdit keydown.preventEdit")
                      .on("input.preventEdit keydown.preventEdit", function (e) {
                        // Sadece uyarÄ± ver, deÄŸeri geri yÃ¼kle
                        setTimeout(() => {
                          const correctValue = slugify($label.val());
                          if ($(this).val() !== correctValue) {
                            $(this).val(correctValue);
                          }
                        }, 10);
                      });
              }
            );
          };

          // Ä°lk Ã§alÄ±ÅŸtÄ±rma
          applyRules();

          // DOM deÄŸiÅŸirse kurallarÄ± tekrar uygula
          const mo = new MutationObserver(debounce(applyRules, 100));
          mo.observe(this.root, { childList: true, subtree: true });
        }

        /**
         * ÅemayÄ± gÃ¼venli hÃ¢le getirir (render & export iÃ§in kullanÄ±lÄ±r).
         * - access/limit_access gibi gÃ¼venlik alanlarÄ±nÄ± temizler
         * - options value'larÄ±nÄ± label'a gÃ¶re slug'lar
         * - name yoksa label'dan gÃ¼venli bir "name" Ã¼retir (stabil form post iÃ§in)
         * - className/class alanlarÄ± korunur (UI'da gizlenmiÅŸ ama default deÄŸerler ile derlenir)
         *
         * @param {Array} schema
         * @returns {Array} sanitized copy
         */
        sanitizeSchema(schema = []) {
          const clone = JSON.parse(JSON.stringify(schema || []));

          const sanitizeField = (f) => {
            // Sadece gÃ¼venlik ile ilgili alanlarÄ± kaldÄ±r (className/class alanlarÄ± korunur)
            delete f.access;
            delete f["access[]"];
            delete f.limit_access;
            
            // "DiÄŸerini EtkinleÅŸtir" Ã¶zelliÄŸini kaldÄ±r
            delete f.other;
            delete f.enableOther;
            
            // "GeÃ§iÅŸ" (Toggle/Switch) Ã¶zelliÄŸini kaldÄ±r
            delete f.toggle;
            delete f.switch;

            // name yoksa label'dan Ã¼ret (stabil backend name)
            if (!f.name && f.label) {
              f.name = slugify(String(f.label)).replace(/-/g, "_");
            }

            // SeÃ§enekleri normalize et (value = slug(label))
            if (Array.isArray(f.values)) {
              f.values = f.values.map((opt) => {
                const safe = { ...opt };
                const safeLabel = String(safe.label ?? "").trim();
                const proposed = slugify(safeLabel);
                if (!safe.value || safe.value !== proposed) {
                  safe.value = proposed;
                }
                return safe;
              });
            }

            // BazÄ± field tipleri nested children taÅŸÄ±yabilir
            if (Array.isArray(f.columns)) {
              f.columns.forEach((col) => {
                if (Array.isArray(col.fields)) {
                  col.fields = col.fields.map((cf) => sanitizeField(cf));
                }
              });
            }
            if (Array.isArray(f.subfields)) {
              f.subfields = f.subfields.map((sf) => sanitizeField(sf));
            }
            return f;
          };

          return clone.map((f) => sanitizeField(f));
        }
      }

      /* ============================================================
         PreviewService
         - Ã–nizlemeyi ve Ã§Ä±ktÄ± textarealarÄ±nÄ± gÃ¼nceller
         - UI'de "GÃ¶nder" butonu ve submit engelleme
         - Her zaman sanitize edilmiÅŸ ÅŸemayÄ± kullanÄ±r
      ============================================================ */
      class PreviewService {
        /**
         * @param {UiPolicyService} uiPolicy - sanitize iÅŸlemleri iÃ§in
         */
        constructor(uiPolicy) {
          this.uiPolicy = uiPolicy;
        }

        /**
         * Ã–nizleme ve Ã§Ä±ktÄ±larÄ± gÃ¼nceller
         * @param {Object} fbInstance - formBuilder instance
         */
        update(fbInstance) {
          // 1) Raw ÅŸemayÄ± Ã§ek ve normalize et
          const raw = fbInstance.actions.getData("json");
          const { obj } = normalizeSchema(raw);

          // 2) GÃ¼venli/sanitize ÅŸema Ã¼ret
          const safeObj = this.uiPolicy.sanitizeSchema(obj);
          const safeStr = JSON.stringify(safeObj, null, 2);

          // 3) Ã–nizleme alanÄ±nÄ± render et
          $("#form-preview").html("");
          $("#form-preview").formRender({
            dataType: "json",
            formData: safeStr,
          });

          // 4) Sabit "GÃ¶nder" butonu (tek ve her zaman mevcut)
          if ($("#form-preview button[type=submit]").length === 0) {
            $("#form-preview").append(
              '<button type="submit" class="btn btn-primary mt-3">GÃ¶nder</button>'
            );
          }

          // 5) Ã–nizleme submit engeli
          $("#form-preview")
            .off("submit.preview")
            .on("submit.preview", function (e) {
              e.preventDefault();
              alert("Form baÅŸarÄ±yla gÃ¶nderildi.");
              return false;
            });

          // 6) HTML Ã§Ä±ktÄ±sÄ± Ã¼ret (geÃ§ici div Ã¼zerinden, chainable hatasÄ±nÄ± Ã¶nler)
          const tempDiv = $("<div>");
          tempDiv.formRender({ dataType: "json", formData: safeStr });
          const innerHtml = tempDiv.html();
          const fullFormHtml = `
            <form id="form-extra-questions">
              ${innerHtml}
              <button type="submit" class="btn btn-success mt-3">GÃ¶nder</button>
            </form>
          `;

          // 7) Ã‡Ä±ktÄ± textarea'larÄ±nÄ± gÃ¼ncelle
          $("#json-output").val(safeStr);
          $("#html-output").val(fullFormHtml.trim());

          // 8) Debug (isteÄŸe baÄŸlÄ±)
          console.log("[Preview] JSON", safeObj);
        }
      }

      /* ============================================================
         ButtonsService
         - Kendi "Temizle" butonumuzu enjekte eder
         - FormBuilder'Ä±n dahili action butonlarÄ±nÄ± gizler (yalÄ±n UI)
      ============================================================ */
      class ButtonsService {
        /**
         * @param {Object} params
         * @param {Object} params.fbInstance
         * @param {Function} params.onAfterClear - temizle sonrasÄ± callback
         */
        constructor({ fbInstance, onAfterClear }) {
          this.fb = fbInstance;
          this.onAfterClear = onAfterClear;
          this.injectCustomToolbar();
          this.hidePluginButtons();
          this.observeForReHide();
        }

        injectCustomToolbar() {
          const html = `
            <div class="d-flex gap-2">
              <button id="ys-clear-btn" type="button" class="btn btn-danger btn-sm">Temizle</button>
            </div>
          `;
          $("#ys-toolbar").html(html);

          $("#ys-clear-btn")
            .off("click")
            .on("click", () => {
              if (!confirm("TÃ¼m alanlarÄ± silmek istediÄŸinize emin misiniz?")) return;
              try {
                if (typeof this.fb.actions.clearFields === "function") {
                  this.fb.actions.clearFields();
                } else if (typeof this.fb.actions.setData === "function") {
                  try {
                    this.fb.actions.setData("[]");
                  } catch {
                    this.fb.actions.setData([]);
                  }
                }
              } catch (e) {
                console.warn("Temizleme sÄ±rasÄ±nda hata:", e);
              }
              if (typeof this.onAfterClear === "function") this.onAfterClear();
            });
        }

        hidePluginButtons() {
          // FormBuilder'Ä±n render ettiÄŸi butonlarÄ± gizle (Save, View JSON, Clear vs.)
          $("#fb-editor, #fb-editor + div, #fb-editor *")
            .find('button, a, input[type="button"]')
            .each(function () {
              const $b = $(this);
              const txt = ($b.text() || $b.val() || "").trim();
              if ($b.is("#ys-clear-btn") || /Temizle/i.test(txt)) return; // kendi butonumuz kalsÄ±n
              $b.hide();
            });
        }

        observeForReHide() {
          const mo = new MutationObserver(debounce(() => this.hidePluginButtons(), 80));
          mo.observe(document.getElementById("fb-editor"), {
            childList: true,
            subtree: true,
          });
        }
      }

      /* ============================================================
         FormBuilderService
         - formBuilder init & hazÄ±r olmasÄ±nÄ± bekleme
         - clear/setData override (silme/temizleme algÄ±lansÄ±n)
         - DOM mutasyonlarÄ±nÄ± izleme (ekleme/gÃ¼ncelleme algÄ±lansÄ±n)
         - Åema snapshot kÄ±yasÄ± (stabil tespit)
      ============================================================ */
      class FormBuilderService {
        /**
         * @param {Object} params
         * @param {Object} params.options - formBuilder konfigÃ¼rasyonu
         * @param {Function} params.onChange - her deÄŸiÅŸiklikte tetiklenecek callback
         * @param {Array} params.initialData - baÅŸlangÄ±Ã§ form verisi (opsiyonel)
         */
        constructor({ options, onChange, initialData = null }) {
          this.options = options;
          this.onChange = onChange;
          this.initialData = initialData;
          this.instance = null;
          this.lastSnapshot = [];
        }

        /**
         * formBuilder'Ä± baÅŸlatÄ±r ve hazÄ±r olduktan sonra hook/observer kurar
         */
        init() {
          this.instance = $("#fb-editor").formBuilder(this.options);

          // HazÄ±r olmasÄ±nÄ± garanti et (formBuilder is still initialising hatasÄ±nÄ± Ã¶nler)
          this.instance.promise.then(() => {
            this.lastSnapshot = this._snapshot();
            this._hookActions();
            this._observeDom();
            
            // BaÅŸlangÄ±Ã§ verisi ayarla (eÄŸer varsa)
            this._setInitialData();
            
            // Ä°lk render
            this._emitChange();
          });
        }

        /**
         * BaÅŸlangÄ±Ã§ verisini ayarlar
         * @private
         */
        _setInitialData() {
          // EÄŸer baÅŸlangÄ±Ã§ verisi yoksa hiÃ§bir ÅŸey yapma
          if (!this.initialData || !Array.isArray(this.initialData) || this.initialData.length === 0) {
            return;
          }

          try {
            // FormBuilder'a baÅŸlangÄ±Ã§ verisini yÃ¼kle
            this.instance.actions.setData(JSON.stringify(this.initialData));
            
            // Snapshot'Ä± gÃ¼ncelle (temizleme algÄ±lanmasÄ±n)
            setTimeout(() => {
              this.lastSnapshot = this._snapshot();
            }, 100);
            
            console.log("[FormBuilder] BaÅŸlangÄ±Ã§ verisi yÃ¼klendi:", this.initialData);
          } catch (e) {
            console.warn("[FormBuilder] BaÅŸlangÄ±Ã§ verisi yÃ¼klenirken hata:", e);
          }
        }

        /**
         * formBuilder'Ä±n action metodlarÄ±nÄ± override ederek
         * setData/clearFields sonrasÄ± da deÄŸiÅŸiklik yayÄ±lmasÄ±nÄ± saÄŸlar
         */
        _hookActions() {
          const fb = this.instance;
          if (!fb || !fb.actions) return;

          const origSetData = fb.actions.setData;
          const origClear = fb.actions.clearFields;

          fb.actions.setData = (...args) => {
            const res = origSetData.apply(fb.actions, args);
            this._emitChange();
            return res;
          };

          fb.actions.clearFields = (...args) => {
            const res = origClear.apply(fb.actions, args);
            this._emitChange();
            return res;
          };

          // BazÄ± eylemler buton tÄ±klamasÄ± ile olur (option ekleme vb.); tÄ±klamalarÄ± da dinle
          $(document).on(
            "click.fb_change",
            "#fb-editor .add, .add-option, .fld-add, .fb-add, .del-button, .remove, .close-field",
            debounce(() => this._checkAndEmit())
          );
        }

        /**
         * DOM deÄŸiÅŸikliklerini gÃ¶zleyerek (Ã¶zellikle sÃ¼rÃ¼kle-bÄ±rak eklemeleri) yakalar
         */
        _observeDom() {
          const debounced = debounce(() => this._checkAndEmit(), 80);
          const mo = new MutationObserver(debounced);
          mo.observe(document.getElementById("fb-editor"), {
            childList: true,
            subtree: true,
          });
        }

        /**
         * AnlÄ±k ÅŸema snapshot
         * @returns {Array}
         */
        _snapshot() {
          try {
            const raw = this.instance.actions.getData("json");
            return normalizeSchema(raw).obj;
          } catch {
            return [];
          }
        }

        /**
         * DeÄŸiÅŸiklik varsa onChange yayÄ±nla
         */
        _checkAndEmit() {
          const cur = this._snapshot();
          if (!deepEqual(cur, this.lastSnapshot)) {
            this.lastSnapshot = cur;
            this._emitChange();
          }
        }

        /**
         * DÄ±ÅŸ dÃ¼nyaya deÄŸiÅŸikliÄŸi bildir (preview/Ã§Ä±ktÄ±lar gÃ¼ncellensin)
         */
        _emitChange() {
          if (typeof this.onChange === "function") {
            this.onChange(this.instance);
          }
        }
      }

      /* ============================================================
         Vue App
         - Sadece state ve yaÅŸam dÃ¶ngÃ¼sÃ¼
         - Servisler tÃ¼m iÅŸ yÃ¼kÃ¼nÃ¼ yapar (SRP)
      ============================================================ */
      const app = Vue.createApp({
        data() {
          return {
            i18n: { locale: "tr-TR" },
            fbService: null,
            previewService: null,
            uiPolicyService: null,
            buttonsService: null,
            // BaÅŸlangÄ±Ã§ form verisi - dÄ±ÅŸarÄ±dan deÄŸiÅŸtirilebilir
            defaultFormData: null
             
          };
        },
        mounted() {
          // 1) UI politikalarÄ± (geliÅŸmiÅŸ alanlarÄ± gizleme + option slug UI)
          this.uiPolicyService = new UiPolicyService({ root: document.body });

          // 2) Preview servisi (sanitize edilmiÅŸ ÅŸema ile render)
          this.previewService = new PreviewService(this.uiPolicyService);

          // 3) FormBuilder servis
          this.fbService = new FormBuilderService({
            options: {
              i18n: this.i18n,
              disableFields: ["file", "hidden", "button"],
              showActionButtons: true,
              stickyControls: { enable: true },
              scrollToFieldOnAdd: false, // Element eklendikten sonra otomatik scroll'u engelle
            },
            onChange: (fbInstance) => this.previewService.update(fbInstance),
            initialData: this.defaultFormData, // BaÅŸlangÄ±Ã§ verisi dÄ±ÅŸarÄ±dan
          });

          // 4) BaÅŸlat ve hazÄ±r olunca butonlarÄ± enjekte et
          this.fbService.init();

          // formBuilder hazÄ±r olduÄŸunda Ã¶zel araÃ§ Ã§ubuÄŸunu kur
          const waitReady = setInterval(() => {
            if (this.fbService?.instance?.promise) {
              this.fbService.instance.promise.then(() => {
                // Kendi "Temizle" butonumuzu baÄŸla ve plugin butonlarÄ±nÄ± gizle
                this.buttonsService = new ButtonsService({
                  fbInstance: this.fbService.instance,
                  onAfterClear: () => this.previewService.update(this.fbService.instance),
                });
              });
              clearInterval(waitReady);
            }
          }, 60);
        },
      });

      app.mount("#app");
    </script>
  </body>
</html>
